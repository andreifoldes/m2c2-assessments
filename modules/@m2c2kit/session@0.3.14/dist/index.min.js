import{M2Error as m,ActivityType as l,M2c2KitHelpers as y,Uuid as A,M2EventType as f,Timer as E,Constants as S}from"@m2c2kit/core";class r{static createRoot(t){const i=document.createElement("div");i.setAttribute("id","m2c2kit-survey-div"),t.appendChild(i);const e=document.createElement("div");e.setAttribute("id","m2c2kit-canvas-div"),e.className="m2c2kit-full-viewport m2c2kit-flex-container";const s=document.createElement("canvas");s.setAttribute("id","m2c2kit-canvas"),s.className="m2c2kit-full-viewport",e.appendChild(s),t.appendChild(e)}static addStyleSheet(t){const i=document.createElement("style");i.innerText=t,document.head.appendChild(i)}static addLoadingElements(){const t=document.getElementById("m2c2kit-canvas-div");if(!t)throw new m("Could not find container element");let i=document.getElementById("m2c2kit-canvas-overlay-div");if(!i){i=document.createElement("div"),i.setAttribute("id","m2c2kit-canvas-overlay-div"),i.className="m2c2kit-canvas-overlay m2c2kit-display-none";const e=document.createElement("div");e.setAttribute("id","m2c2kit-spinner-div"),e.className="m2c2kit-spinner m2c2kit-display-none",t.appendChild(i),t.appendChild(e)}}static configureDomForActivity(t){t.type==l.Game&&(this.setCanvasDivVisibility(!0),this.setSurveyDivVisibility(!1)),t.type==l.Survey&&(this.setCanvasDivVisibility(!1),this.setSurveyDivVisibility(!0),r.setBusyAnimationVisibility(!1),r.setCanvasOverlayVisibility(!1))}static hideM2c2Elements(){this.setCanvasDivVisibility(!1),this.setSurveyDivVisibility(!1)}static setCanvasOverlayVisibility(t){const i=document.getElementById("m2c2kit-canvas-overlay-div");i&&(t?i.classList.remove("m2c2kit-display-none"):i.classList.add("m2c2kit-display-none"))}static setBusyAnimationVisibility(t){const i=document.getElementById("m2c2kit-spinner-div");i&&(t?i.classList.remove("m2c2kit-display-none"):i.classList.add("m2c2kit-display-none"))}static setSurveyDivVisibility(t){const i=document.getElementById("m2c2kit-survey-div");i&&t&&(i.classList.remove("m2c2kit-display-none"),i.classList.add("m2c2kit-display-block")),i&&!t&&(i.classList.add("m2c2kit-display-none"),i.classList.remove("m2c2kit-display-block"))}static setCanvasDivVisibility(t){const i=document.getElementById("m2c2kit-canvas-div");i&&t&&(i.classList.remove("m2c2kit-display-none"),i.classList.add("m2c2kit-flex-container")),i&&!t&&(i.classList.add("m2c2kit-display-none"),i.classList.remove("m2c2kit-flex-container"))}}const u={SessionInitialize:"SessionInitialize",SessionStart:"SessionStart",SessionEnd:"SessionEnd",SessionData:"SessionData"},k=`.m2c2kit-background-color {
  background: white;
}

.m2c2kit-no-margin {
  margin: 0;
}

.m2c2kit-display-none {
  display: none;
}

.m2c2kit-display-block {
  display: block;
}

.m2c2kit-full-viewport {
  height: 100vh;
  width: 100vw;
}

.m2c2kit-flex-container {
  display: flex;
  justify-content: center;
  align-items: center;
}

.m2c2kit-canvas-overlay {
  background-color: white;
  width: 100vw;
  height: 100vh;
  position: absolute
}

.m2c2kit-spinner {
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid #212529;
  width: 120px;
  height: 120px;
  /* Safari */
  -webkit-animation: m2c2kit-loader-spin 1.5s linear infinite;
  animation: m2c2kit-loader-spin 1.5s linear infinite;
  position: absolute;
}

#m2c2kit-time-stepping-div {
  position: fixed;
  top: 4px;
  left: 4px
}

/* Safari */
@-webkit-keyframes m2c2kit-loader-spin {
  0% {
    -webkit-transform: rotate(0deg);
  }

  100% {
    -webkit-transform: rotate(360deg);
  }
}

@keyframes m2c2kit-loader-spin {
  0% {
    transform: rotate(0deg);
  }

  100% {
    transform: rotate(360deg);
  }
}`,b=class v{constructor(t){this.onDialogConfirm=t.onDialogConfirm,this.removeOverlayAfterConfirm=t.removeOverlayAfterConfirm??!0,this.overlay=document.createElement("div"),this.overlay.style.position="fixed",this.overlay.style.top="0",this.overlay.style.left="0",this.overlay.style.width="100vw",this.overlay.style.height="100vh",this.overlay.style.backgroundColor="#fff",this.overlay.style.display="flex",this.overlay.style.justifyContent="center",this.overlay.style.alignItems="center",this.overlay.style.zIndex="1000";const i=document.createElement("div");i.textContent=t.backgroundCharacter??null,i.style.position="absolute",i.style.fontSize="20rem",i.style.opacity="0.40",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",this.dialog=document.createElement("div"),this.dialog.style.backgroundColor="#fff",this.dialog.style.padding="20px",this.dialog.style.borderRadius="10px",this.dialog.style.boxShadow="0px 4px 10px rgba(0, 0, 0, 0.3)",this.dialog.style.textAlign="center",this.dialog.style.minWidth="200px",this.dialog.style.maxWidth="75%",this.dialog.style.opacity=".80",this.dialog.style.position="relative",this.dialog.style.zIndex="1001",this.message=document.createElement("p"),this.message.textContent=t.message,this.message.style.marginBottom="15px",this.message.style.fontFamily="Arial, sans-serif",this.button=document.createElement("button"),this.button.textContent="OK",this.button.style.padding="8px 15px",this.button.style.border="none",this.button.style.backgroundColor="#007bff",this.button.style.color="#fff",this.button.style.borderRadius="5px",this.button.style.cursor="pointer",this.button.style.fontSize="16px",this.button.style.fontFamily="Arial, sans-serif",this.button.onclick=this.close.bind(this),this.dialog.appendChild(this.message),this.dialog.appendChild(this.button),this.overlay.appendChild(i),this.overlay.appendChild(this.dialog)}show(){v.activeDialog&&v.activeDialog!==this&&v.activeDialog.forceClose(),v.activeDialog=this,document.body.appendChild(this.overlay)}static isDialogVisible(){return v.activeDialog!==null}forceClose(){this.dialog.parentNode===this.overlay&&(this.overlay.removeChild(this.dialog),this.removeOverlayAfterConfirm&&this.overlay.remove()),this.button.onclick=null,v.activeDialog=null}close(){this.dialog.parentNode===this.overlay&&(this.overlay.removeChild(this.dialog),this.removeOverlayAfterConfirm&&this.overlay.remove()),this.button.onclick=null,v.activeDialog=null,this.onDialogConfirm&&this.onDialogConfirm()}};b.activeDialog=null;let D=b;const C=10;class L{constructor(t){this.staticDiagnosticData={},this.isHandlingException=!1,this.reportedExceptions=new Set,this.diagnosticEventsCount=0,this.getSessionUuid=t.getSessionUuid,this.getCurrentActivity=t.getCurrentActivity,this.dispatchEvent=t.dispatchEvent,this.onErrorDialogConfirm=t.onErrorDialogConfirm||(()=>{}),this.removeOverlayAfterErrorDialogConfirm=t.removeOverlayAfterErrorDialogConfirm??!1,this.onlyM2Errors=t.onlyM2Errors??!0,this.handleResourceLoadingErrors=t.handleResourceLoadingErrors??!1,this.maximumDiagnosticEvents=t.maximumDiagnosticEvents??C,this.errorHandler=this.handleError.bind(this),this.rejectionHandler=this.handleRejection.bind(this),this.resourceErrorHandler=this.handleResourceError.bind(this),this.refreshBatteryStatus(),this.refreshStorageEstimate()}addStaticDiagnosticData(t,i){this.staticDiagnosticData[t]=i}start(){window.addEventListener("error",this.errorHandler),window.addEventListener("unhandledrejection",this.rejectionHandler),this.handleResourceLoadingErrors&&document.addEventListener("error",this.resourceErrorHandler,!0)}stop(){window.removeEventListener("error",this.errorHandler),window.removeEventListener("unhandledrejection",this.rejectionHandler),document.removeEventListener("error",this.resourceErrorHandler,!0)}handleError(t){return this.onlyM2Errors&&t.error&&t.error.name!=="M2Error"||this.handleException(t.error||new Error(t.message),{source:t.filename,lineno:t.lineno,colno:t.colno,type:"synchronous"}),!1}handleRejection(t){let i;if(t.reason instanceof Error)i=t.reason;else if(typeof t.reason=="string")i=new Error(t.reason);else try{i=new Error(JSON.stringify(t.reason))}catch{i=new Error("Unhandled Promise rejection with unserializable reason")}if(this.onlyM2Errors&&i&&i.name!=="M2Error")return!1;const e=this.extractErrorLocationFromStack(i.stack);return this.handleException(i,{source:e.source||"promise_rejection",lineno:e.lineno,colno:e.colno,type:"promise_rejection"}),!1}extractErrorLocationFromStack(t){if(!t)return{};const e=t.split(`
`).slice(0,20);for(let s=0;s<e.length;s++){const n=e[s].trim();if(!n)continue;const a=n.match(/at .*? \(([^)]+):(\d+):(\d+)\)/);if(a)return{source:a[1],lineno:parseInt(a[2],10),colno:parseInt(a[3],10)};const o=n.match(/at ([^ ]+):(\d+):(\d+)/);if(o)return{source:o[1],lineno:parseInt(o[2],10),colno:parseInt(o[3],10)};const c=n.match(/(?:@|at )([^@]+):(\d+):(\d+)/);if(c)return{source:c[1],lineno:parseInt(c[2],10),colno:parseInt(c[3],10)};const d=n.match(/([^@\s]+)(?:.*?)?:(\d+):(\d+)$/);if(d)return{source:d[1],lineno:parseInt(d[2],10),colno:parseInt(d[3],10)};const h=n.match(/([^:]+):(\d+):(\d+)/);if(h)return{source:h[1],lineno:parseInt(h[2],10),colno:parseInt(h[3],10)}}return{}}handleResourceError(t){if(t.target instanceof HTMLImageElement||t.target instanceof HTMLScriptElement){let i="src"in t.target?t.target.src:"unknown";i=this.truncateString(i,100),this.handleException(new Error(`Error on element ${t.target.nodeName} in document at ${document.URL}. Failed to load resource: ${i}`),{source:"resource_loading",type:"resource_loading"})}}handleException(t,i){if(this.isHandlingException){console.error("Error occurred while handling another exception",t);return}const e=`${t.message}:${i?.lineno||0}:${i?.colno||0}`;if(!this.reportedExceptions.has(e)){if(this.reportedExceptions.add(e),this.diagnosticEventsCount++,this.diagnosticEventsCount>this.maximumDiagnosticEvents){console.warn(`Maximum diagnostic events reached (${this.maximumDiagnosticEvents}). No more will be reported.`);return}try{this.isHandlingException=!0,D.isDialogVisible()?console.log("Error dialog already visible, not showing another one"):new D({message:"We are sorry, but something went wrong. Please try again later.",backgroundCharacter:"\u26A0\uFE0F",onDialogConfirm:this.onErrorDialogConfirm,removeOverlayAfterConfirm:this.removeOverlayAfterErrorDialogConfirm}).show();const s=this.getCurrentActivity(),{timestamp:n,iso8601Timestamp:a}=y.createTimestamps(),o={data_type:"diagnostics",document_uuid:A.generate(),iso8601_timestamp:a,session_uuid:this.getSessionUuid(),activity:{id:s?.id??null,uuid:s?.uuid??null,publish_uuid:s?.publishUuid??null,version:s?.type===l.Game?s.options.version:null,begin_iso8601_timestamp:s?.type===l.Game?s.beginIso8601Timestamp:null,locale:s?.type===l.Game?s.i18n?.locale??null:null},error_message:t.message,error_stack:this.truncateString(t.stack,2048)??null,error_source:i?.source??null,error_line:i?.lineno||0,error_column:i?.colno||0,error_type:i?.type??null,device_metadata:this.getExtendedDeviceMetadata(),...this.staticDiagnosticData},c={target:null,type:u.SessionData,data:o,dataType:"Diagnostics",timestamp:n,iso8601Timestamp:a};this.dispatchEvent(c),console.log("\u274C diagnostics:",t,i)}finally{this.isHandlingException=!1}}}getExtendedDeviceMetadata(){try{const t=window.screen||{};let i;try{i=t.orientation||void 0}catch{}return{userAgent:navigator?.userAgent,language:navigator?.language,hardwareConcurrency:navigator?.hardwareConcurrency,deviceMemory:typeof navigator?.deviceMemory<"u"?navigator.deviceMemory:void 0,connection:(()=>{try{const e=navigator?.connection;return e?{effectiveType:e?.effectiveType,downlink:e?.downlink,downlinkMax:e?.downlinkMax,rtt:e?.rtt,saveData:e?.saveData,type:e?.type}:void 0}catch{return}})(),battery:this.batteryStatus,storage:this.storageEstimate,cookieEnabled:navigator?.cookieEnabled,webAssembly:typeof WebAssembly<"u",maxTouchPoints:navigator?.maxTouchPoints,devicePixelRatio:window?.devicePixelRatio,screen:{availHeight:t?.availHeight,availWidth:t?.availWidth,colorDepth:t?.colorDepth,height:t?.height,orientation:i?{type:i?.type,angle:i?.angle}:void 0,pixelDepth:t?.pixelDepth,width:t?.width},device_timezone:Intl?.DateTimeFormat()?.resolvedOptions()?.timeZone||"",device_timezone_offset_minutes:new Date().getTimezoneOffset()}}catch(t){return console.warn("Error collecting device metadata:",t),{userAgent:navigator?.userAgent||"unknown"}}}refreshBatteryStatus(){try{if(!("getBattery"in navigator))return;const t=new Promise((i,e)=>{setTimeout(()=>e(new Error("Battery status timeout")),2e3)});Promise.race([navigator.getBattery(),t]).then(i=>{this.batteryStatus={charging:i?.charging,level:i?.level,chargingTime:i?.chargingTime,dischargingTime:i?.dischargingTime}}).catch(i=>{console.warn("Battery status API error:",i),this.batteryStatus=void 0})}catch(t){console.warn("Unexpected error in battery status check:",t)}}refreshStorageEstimate(){try{if(!("storage"in navigator&&"estimate"in navigator.storage))return;const t=new Promise((i,e)=>{setTimeout(()=>e(new Error("Storage estimate timeout")),2e3)});Promise.race([navigator.storage.estimate(),t]).then(i=>{this.storageEstimate={quota:i.quota,usage:i.usage}}).catch(i=>{console.warn("Storage estimation API error:",i),this.storageEstimate=void 0})}catch(t){console.warn("Unexpected error in storage estimation check:",t)}}truncateString(t,i){return t?t.length<=i?t:t.slice(0,i)+`...(truncated from ${t.length} characters)`:""}}class I{constructor(t){this.eventListeners=new Array,this.sessionDictionary=new Map,this.initialized=!1,this.options=t,window.m2c2kitSession=this,this.addDebuggingTools()}addDebuggingTools(){const t=new URLSearchParams(window.location.search),i=t.get("diagnostics");i!==null?i==="true"&&this.startDiagnostics():this.options.diagnostics===!0&&this.startDiagnostics(),t.get("eruda")==="true"&&y.loadEruda();const e=t.get("scripts");if(e)try{const s=JSON.parse(decodeURIComponent(e));y.loadScriptUrls(s)}catch{console.log('Error parsing "scripts" parameter. "scripts" must be an array of URL strings, and it is recommended to be URI encoded.')}}startDiagnostics(){this.diagnosticsReporter&&this.diagnosticsReporter.stop(),this.diagnosticsReporter=new L({getSessionUuid:()=>this.uuid,getCurrentActivity:()=>this.currentActivity,dispatchEvent:this.raiseEventOnListeners.bind(this),onErrorDialogConfirm:this.end.bind(this)}),this.diagnosticsReporter.start()}onInitialize(t,i){this.addEventListener(u.SessionInitialize,t,i)}onStart(t,i){this.addEventListener(u.SessionStart,t,i)}onEnd(t,i){this.addEventListener(u.SessionEnd,t,i)}onData(t,i){this.addEventListener(u.SessionData,t,i)}onActivityData(t,i){this.addEventListener(f.ActivityData,t,i)}addEventListener(t,i,e){const s={type:t,callback:i,key:e?.key};e?.replaceExisting&&(this.eventListeners=this.eventListeners.filter(n=>n.type!==s.type)),this.eventListeners.push(s)}raiseEventOnListeners(t,i){i&&(t={...t,...i}),this.eventIsSessionDataEventMissingTarget(t)&&(t.target=this),this.eventListeners.filter(e=>e.type===t.type).forEach(e=>{e.callback(t)})}eventIsSessionDataEventMissingTarget(t){return t.type===u.SessionData&&t.dataType==="Diagnostics"&&!t.target}async sessionActivityStartHandler(t){const i=t.target.type===l.Game?"game":"survey";console.log(`\u{1F7E2} started activity (${i}) ${t.target.name}`)}async sessionActivityCancelHandler(t){const i=t.target.type===l.Game?"game":"survey";if(console.log(`\u{1F6AB} canceled activity (${i}) ${t.target.name}`),this.nextActivity&&this.options.autoGoToNextActivity!==!1){await this.goToNextActivity();return}!this.nextActivity&&this.options.autoEndAfterLastActivity!==!1&&this.end()}async sessionActivityEndHandler(t){const i=t.target.type===l.Game?"game":"survey";if(console.log(`\u{1F534} ended activity (${i}) ${t.target.name}`),this.nextActivity&&this.options.autoGoToNextActivity!==!1){await this.goToNextActivity();return}!this.nextActivity&&this.options.autoEndAfterLastActivity!==!1&&this.end()}async sessionActivityLifecycleHandler(t){if(t.type===f.ActivityStart){await this.sessionActivityStartHandler(t);return}if(t.type===f.ActivityCancel){await this.sessionActivityCancelHandler(t);return}if(t.type===f.ActivityEnd){await this.sessionActivityEndHandler(t);return}throw new m("unknown activity lifecycle event type")}activityResultsEventHandler(t){this.raiseEventOnListeners(t)}async init(){return console.warn("The init() method of Session is deprecated. Use initialize() instead."),this.initialize()}activityUsesDeprecatedInit(t){if(t.type===l.Survey)return!1;const i=Object.getPrototypeOf(t),e=Object.getPrototypeOf(i);return i?.init!==e?.init}async initialize(){E.startNew("sessionInitialize"),this.options.sessionUuid?this.uuid=this.options.sessionUuid:this.uuid=A.generate();for(const s of this.options.activities){if(this.options.activities.filter(n=>n===s).length>1)throw new m(`error in SessionOptions.activities: an instance of the activity named "${s.name}" has been added more than once to the session. If you want to repeat the same activity, create separate instances of it.`);if(s.sessionUuid=this.uuid,this.options.activityCallbacks?.onActivityLifecycle&&(s.onStart(this.options.activityCallbacks.onActivityLifecycle),s.onCancel(this.options.activityCallbacks.onActivityLifecycle),s.onEnd(this.options.activityCallbacks.onActivityLifecycle)),this.options.activityCallbacks?.onActivityResults&&s.onData(this.options.activityCallbacks.onActivityResults),s.type===l.Game){const n=s;n.onWarmupStart(()=>{r.setCanvasOverlayVisibility(!0)}),n.onWarmupEnd(()=>{r.setCanvasOverlayVisibility(!1),r.setBusyAnimationVisibility(!1)})}}const t={target:this,type:u.SessionInitialize,...y.createTimestamps()};this.raiseEventOnListeners(t);const i=this.options.rootElementId??S.DEFAULT_ROOT_ELEMENT_ID,e=document.getElementById(i);if(!e)throw new m(`Session.initialize(): root element with id ${i} not found. The index.html should have: <div id="${i}"></div>.`);if(r.createRoot(e),r.addStyleSheet(this.options.styleSheet??k),r.addLoadingElements(),r.setBusyAnimationVisibility(!0),r.setCanvasOverlayVisibility(!0),this.dataStores=this.options.dataStores,this.dataStores?.length===0)throw new m("Session.initialize(): dataStores must be undefined or a non-zero array of datastores.");await this.getSharedAssets(this.options.activities),await Promise.all(this.options.activities.map(s=>(s.studyId=this.options.studyId,s.studyUuid=this.options.studyUuid,s.dataStores=this.dataStores,s.onStart(this.sessionActivityLifecycleHandler.bind(this)),s.onCancel(this.sessionActivityLifecycleHandler.bind(this)),s.onEnd(this.sessionActivityLifecycleHandler.bind(this)),s.onData(n=>{this.activityResultsEventHandler(n)}),this.activityUsesDeprecatedInit(s)?(console.warn(`game ${s.id}: Activity.init() is deprecated. In the assessment class that extends Game, use Activity.initialize() instead:
  async initialize() {
    await super.initialize();
    ...
  }
`),s.init()):s.initialize()))),console.log(`\u26AA Session.initialize() took ${E.elapsed("sessionInitialize").toFixed(0)} ms`),E.remove("sessionInitialize"),this.initialized=!0,this.options.autoStartAfterInit!==!1&&await this.start()}async getSharedAssets(t){const i=t.filter(e=>e.type===l.Game&&e.options.shareAssets!==!1);if(i.length>0){const e=await i[0].loadManifest();i.forEach(a=>{a.manifest=e});const s=this.initializeSharedCanvasKit(i),n=this.fetchSharedFontData(i);await Promise.all([...s,...n])}}initializeSharedCanvasKit(t){const i=this.getDuplicates(t.map(n=>n.canvasKitWasmVersion)),e=t.map(n=>({game:n,version:n.canvasKitWasmVersion,data:void 0}));return i.map(async n=>{const o=e.filter(g=>g.version===n)[0].game,c=await o.resolveGameBaseUrls(o),d=`canvaskit-${o.canvasKitWasmVersion}.wasm`,h=y.getUrlFromManifest(o,`${c.canvasKitWasm}/${d}`);console.log(`\u26AA sharing ${d} within session`);const w=await o.loadCanvasKit(h);t.forEach(g=>{g.canvasKitWasmVersion===n&&(g.canvasKit=w)})})}fetchSharedFontData(t){const i=t.flatMap(a=>a.options.fonts?.filter(o=>o.lazy!==!0)??[]).map(a=>this.getFilenameFromUrl(a.url)),e=this.getDuplicates(i),s=t.flatMap(a=>(a.options.fonts??[]).map(o=>({game:a,fontAsset:o,filename:this.getFilenameFromUrl(o.url),data:void 0})));return e.map(async a=>{const o=s.filter(p=>p.filename===a)[0],c=o.game,d=await c.resolveGameBaseUrls(c),h=y.getUrlFromManifest(c,`${d.assets}/${o.fontAsset.url}`);console.log(`\u26AA sharing ${this.getFilenameFromUrl(h)} within session`);const g=await(await fetch(h)).arrayBuffer();t.flatMap(p=>p.options.fonts??[]).forEach(p=>{this.getFilenameFromUrl(p.url)===a&&(p.sharedFont={url:h,data:g})})})}async waitForSessionInitialization(){for(;!this.initialized;)await new Promise(t=>setTimeout(t,S.SESSION_INITIALIZATION_POLLING_INTERVAL_MS))}async start(){await this.waitForSessionInitialization(),console.log("\u{1F7E2} started session");const t={target:this,type:u.SessionStart,...y.createTimestamps()};this.raiseEventOnListeners(t),this.currentActivity=this.options.activities.find(Boolean),this.currentActivity?(r.configureDomForActivity(this.currentActivity),await this.currentActivity.start()):(console.warn("no activities in session."),this.end())}end(){console.log("\u{1F534} ended session"),r.hideM2c2Elements(),this.stop();const t={target:this,type:u.SessionEnd,...y.createTimestamps()};this.raiseEventOnListeners(t),this.diagnosticsReporter&&(this.diagnosticsReporter.stop(),this.diagnosticsReporter=void 0)}stop(){this.dispose()}dispose(){}async goToActivity(t){const i=this.options.activities.filter(a=>a.id===t.id).find(Boolean);if(!i)throw new m(`Error in goToActivity(): Session does not contain an activity with id ${t.id}.`);this.currentActivity&&this.currentActivity.stop();const e=i,s=e.constructor.bind.apply(e.constructor,[null]);this.currentActivity=new s;const n=this.options.activities.indexOf(e);this.options.activities[n]=this.currentActivity,r.configureDomForActivity(this.currentActivity),this.currentActivity.dataStores=this.dataStores,e.additionalParameters&&this.currentActivity.setParameters(e.additionalParameters),await this.currentActivity.initialize(),await this.currentActivity.start()}async goToNextActivity(){if(!this.currentActivity)throw new m("error in advanceToNextActivity(): no current activity");if(!this.nextActivity)throw new m("error in advanceToNextActivity(): no next activity");this.currentActivity.stop(),this.currentActivity=this.nextActivity,r.configureDomForActivity(this.currentActivity),await this.currentActivity.start()}async advanceToNextActivity(){await this.goToNextActivity()}get nextActivity(){if(!this.currentActivity)throw new m("error in get nextActivity(): no current activity");if(this.options.activities.indexOf(this.currentActivity)===this.options.activities.length-1)return;const i=this.options.activities.indexOf(this.currentActivity);return this.options.activities[i+1]}dictionarySetItem(t,i){this.sessionDictionary.set(t,i)}dictionaryGetItem(t){return this.sessionDictionary.get(t)}dictionaryDeleteItem(t){return this.sessionDictionary.delete(t)}dictionaryItemExists(t){return this.sessionDictionary.has(t)}getFilenameFromUrl(t){return t.substring(t.lastIndexOf("/")+1)}getDuplicates(t){const i={},e=[];for(const s of t)i[s]=(i[s]||0)+1,i[s]===2&&e.push(s);return e}get uuid(){return this._uuid?this._uuid:(console.warn("Session.uuid is undefined. Returning empty UUID."),"00000000-0000-0000-0000-000000000000")}set uuid(t){this._uuid=t}addStaticDiagnosticData(t,i){this.diagnosticsReporter?this.diagnosticsReporter.addStaticDiagnosticData(t,i):console.warn("Session.addStaticDiagnosticData(): diagnostics reporter has not been created.")}}console.log("\u26AA @m2c2kit/session version 0.3.14 (f8bdff76)");export{r as DomHelper,I as Session,u as SessionEventType};
