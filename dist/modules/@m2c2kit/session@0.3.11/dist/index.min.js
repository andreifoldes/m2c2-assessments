import{ActivityType as c,M2c2KitHelpers as l,M2EventType as p,Timer as f,Uuid as w,Constants as g}from"@m2c2kit/core";class a{static createRoot(t){const i=document.createElement("div");i.setAttribute("id","m2c2kit-survey-div"),t.appendChild(i);const e=document.createElement("div");e.setAttribute("id","m2c2kit-canvas-div"),e.className="m2c2kit-full-viewport m2c2kit-flex-container";const s=document.createElement("canvas");s.setAttribute("id","m2c2kit-canvas"),s.className="m2c2kit-full-viewport",e.appendChild(s),t.appendChild(e)}static addStyleSheet(t){const i=document.createElement("style");i.innerText=t,document.head.appendChild(i)}static addLoadingElements(){const t=document.getElementById("m2c2kit-canvas-div");if(!t)throw new Error("Could not find container element");let i=document.getElementById("m2c2kit-canvas-overlay-div");if(!i){i=document.createElement("div"),i.setAttribute("id","m2c2kit-canvas-overlay-div"),i.className="m2c2kit-canvas-overlay m2c2kit-display-none";const e=document.createElement("div");e.setAttribute("id","m2c2kit-spinner-div"),e.className="m2c2kit-spinner m2c2kit-display-none",t.appendChild(i),t.appendChild(e)}}static configureDomForActivity(t){t.type==c.Game&&(this.setCanvasDivVisibility(!0),this.setSurveyDivVisibility(!1)),t.type==c.Survey&&(this.setCanvasDivVisibility(!1),this.setSurveyDivVisibility(!0),a.setBusyAnimationVisibility(!1),a.setCanvasOverlayVisibility(!1))}static hideM2c2Elements(){this.setCanvasDivVisibility(!1),this.setSurveyDivVisibility(!1)}static setCanvasOverlayVisibility(t){const i=document.getElementById("m2c2kit-canvas-overlay-div");i&&(t?i.classList.remove("m2c2kit-display-none"):i.classList.add("m2c2kit-display-none"))}static setBusyAnimationVisibility(t){const i=document.getElementById("m2c2kit-spinner-div");i&&(t?i.classList.remove("m2c2kit-display-none"):i.classList.add("m2c2kit-display-none"))}static setSurveyDivVisibility(t){const i=document.getElementById("m2c2kit-survey-div");i&&t&&(i.classList.remove("m2c2kit-display-none"),i.classList.add("m2c2kit-display-block")),i&&!t&&(i.classList.add("m2c2kit-display-none"),i.classList.remove("m2c2kit-display-block"))}static setCanvasDivVisibility(t){const i=document.getElementById("m2c2kit-canvas-div");i&&t&&(i.classList.remove("m2c2kit-display-none"),i.classList.add("m2c2kit-flex-container")),i&&!t&&(i.classList.add("m2c2kit-display-none"),i.classList.remove("m2c2kit-flex-container"))}}const d={SessionInitialize:"SessionInitialize",SessionStart:"SessionStart",SessionEnd:"SessionEnd"},E=`.m2c2kit-background-color {
  background: white;
}

.m2c2kit-no-margin {
  margin: 0;
}

.m2c2kit-display-none {
  display: none;
}

.m2c2kit-display-block {
  display: block;
}

.m2c2kit-full-viewport {
  height: 100vh;
  width: 100vw;
}

.m2c2kit-flex-container {
  display: flex;
  justify-content: center;
  align-items: center;
}

.m2c2kit-canvas-overlay {
  background-color: white;
  width: 100vw;
  height: 100vh;
  position: absolute
}

.m2c2kit-spinner {
  border: 16px solid #f3f3f3;
  border-radius: 50%;
  border-top: 16px solid #212529;
  width: 120px;
  height: 120px;
  /* Safari */
  -webkit-animation: m2c2kit-loader-spin 1.5s linear infinite;
  animation: m2c2kit-loader-spin 1.5s linear infinite;
  position: absolute;
}

#m2c2kit-time-stepping-div {
  position: fixed;
  top: 4px;
  left: 4px
}

/* Safari */
@-webkit-keyframes m2c2kit-loader-spin {
  0% {
    -webkit-transform: rotate(0deg);
  }

  100% {
    -webkit-transform: rotate(360deg);
  }
}

@keyframes m2c2kit-loader-spin {
  0% {
    transform: rotate(0deg);
  }

  100% {
    transform: rotate(360deg);
  }
}`;class S{constructor(t){this.eventListeners=new Array,this.sessionDictionary=new Map,this.initialized=!1,this.options=t,window.m2c2kitSession=this,this.addDebuggingTools()}addDebuggingTools(){/eruda=true/.test(window.location.href)&&l.loadEruda();const i=new URLSearchParams(window.location.search).get("scripts");if(i)try{const e=JSON.parse(decodeURIComponent(i));l.loadScriptUrls(e)}catch{console.log('Error parsing "scripts" parameter. "scripts" must be an array of URL strings, and it is recommended to be URI encoded.')}}onInitialize(t,i){this.addEventListener(d.SessionInitialize,t,i)}onStart(t,i){this.addEventListener(d.SessionStart,t,i)}onEnd(t,i){this.addEventListener(d.SessionEnd,t,i)}onActivityData(t,i){this.addEventListener(p.ActivityData,t,i)}addEventListener(t,i,e){const s={type:t,callback:i,key:e?.key};e?.replaceExisting&&(this.eventListeners=this.eventListeners.filter(n=>n.type!==s.type)),this.eventListeners.push(s)}raiseEventOnListeners(t,i){i&&(t={...t,...i}),this.eventListeners.filter(e=>e.type===t.type).forEach(e=>{e.callback(t)})}async sessionActivityStartHandler(t){const i=t.target.type===c.Game?"game":"survey";console.log(`\u{1F7E2} started activity (${i}) ${t.target.name}`)}async sessionActivityCancelHandler(t){const i=t.target.type===c.Game?"game":"survey";if(console.log(`\u{1F6AB} canceled activity (${i}) ${t.target.name}`),this.nextActivity&&this.options.autoGoToNextActivity!==!1){await this.goToNextActivity();return}!this.nextActivity&&this.options.autoEndAfterLastActivity!==!1&&this.end()}async sessionActivityEndHandler(t){const i=t.target.type===c.Game?"game":"survey";if(console.log(`\u{1F534} ended activity (${i}) ${t.target.name}`),this.nextActivity&&this.options.autoGoToNextActivity!==!1){await this.goToNextActivity();return}!this.nextActivity&&this.options.autoEndAfterLastActivity!==!1&&this.end()}async sessionActivityLifecycleHandler(t){if(t.type===p.ActivityStart){await this.sessionActivityStartHandler(t);return}if(t.type===p.ActivityCancel){await this.sessionActivityCancelHandler(t);return}if(t.type===p.ActivityEnd){await this.sessionActivityEndHandler(t);return}throw new Error("unknown activity lifecycle event type")}activityResultsEventHandler(t){this.raiseEventOnListeners(t)}async init(){return console.warn("The init() method of Session is deprecated. Use initialize() instead."),this.initialize()}activityUsesDeprecatedInit(t){if(t.type===c.Survey)return!1;const i=Object.getPrototypeOf(t),e=Object.getPrototypeOf(i);return i?.init!==e?.init}async initialize(){f.startNew("sessionInitialize"),this.options.sessionUuid?this.uuid=this.options.sessionUuid:this.uuid=w.generate();for(const s of this.options.activities){if(this.options.activities.filter(n=>n===s).length>1)throw new Error(`error in SessionOptions.activities: an instance of the activity named "${s.name}" has been added more than once to the session. If you want to repeat the same activity, create separate instances of it.`);if(s.sessionUuid=this.uuid,this.options.activityCallbacks?.onActivityLifecycle&&(s.onStart(this.options.activityCallbacks.onActivityLifecycle),s.onCancel(this.options.activityCallbacks.onActivityLifecycle),s.onEnd(this.options.activityCallbacks.onActivityLifecycle)),this.options.activityCallbacks?.onActivityResults&&s.onData(this.options.activityCallbacks.onActivityResults),s.type===c.Game){const n=s;n.onWarmupStart(()=>{a.setCanvasOverlayVisibility(!0)}),n.onWarmupEnd(()=>{a.setCanvasOverlayVisibility(!1),a.setBusyAnimationVisibility(!1)})}}const t={target:this,type:d.SessionInitialize,...l.createTimestamps()};this.raiseEventOnListeners(t);const i=this.options.rootElementId??g.DEFAULT_ROOT_ELEMENT_ID,e=document.getElementById(i);if(!e)throw new Error(`Session.initialize(): root element with id ${i} not found. The index.html should have: <div id="${i}"></div>.`);if(a.createRoot(e),a.addStyleSheet(this.options.styleSheet??E),a.addLoadingElements(),a.setBusyAnimationVisibility(!0),a.setCanvasOverlayVisibility(!0),this.dataStores=this.options.dataStores,this.dataStores?.length===0)throw new Error("Session.initialize(): dataStores must be undefined or a non-zero array of datastores.");await this.getSharedAssets(this.options.activities),await Promise.all(this.options.activities.map(s=>(s.studyId=this.options.studyId,s.studyUuid=this.options.studyUuid,s.dataStores=this.dataStores,s.onStart(this.sessionActivityLifecycleHandler.bind(this)),s.onCancel(this.sessionActivityLifecycleHandler.bind(this)),s.onEnd(this.sessionActivityLifecycleHandler.bind(this)),s.onData(n=>{this.activityResultsEventHandler(n)}),this.activityUsesDeprecatedInit(s)?(console.warn(`game ${s.id}: Activity.init() is deprecated. In the assessment class that extends Game, use Activity.initialize() instead:
  async initialize() {
    await super.initialize();
    ...
  }
`),s.init()):s.initialize()))),console.log(`\u26AA Session.initialize() took ${f.elapsed("sessionInitialize").toFixed(0)} ms`),f.remove("sessionInitialize"),this.initialized=!0,this.options.autoStartAfterInit!==!1&&await this.start()}async getSharedAssets(t){const i=t.filter(e=>e.type===c.Game&&e.options.shareAssets!==!1);if(i.length>0){const e=await i[0].loadManifest();i.forEach(o=>{o.manifest=e});const s=this.initializeSharedCanvasKit(i),n=this.fetchSharedFontData(i);await Promise.all([...s,...n])}}initializeSharedCanvasKit(t){const i=this.getDuplicates(t.map(n=>n.canvasKitWasmVersion)),e=t.map(n=>({game:n,version:n.canvasKitWasmVersion,data:void 0}));return i.map(async n=>{const r=e.filter(y=>y.version===n)[0].game,h=await r.resolveGameBaseUrls(r),u=`canvaskit-${r.canvasKitWasmVersion}.wasm`,m=l.getUrlFromManifest(r,`${h.canvasKitWasm}/${u}`);console.log(`\u26AA sharing ${u} within session`);const A=await r.loadCanvasKit(m);t.forEach(y=>{y.canvasKitWasmVersion===n&&(y.canvasKit=A)})})}fetchSharedFontData(t){const i=t.flatMap(o=>o.options.fonts?.filter(r=>r.lazy!==!0)??[]).map(o=>this.getFilenameFromUrl(o.url)),e=this.getDuplicates(i),s=t.flatMap(o=>(o.options.fonts??[]).map(r=>({game:o,fontAsset:r,filename:this.getFilenameFromUrl(r.url),data:void 0})));return e.map(async o=>{const r=s.filter(v=>v.filename===o)[0],h=r.game,u=await h.resolveGameBaseUrls(h),m=l.getUrlFromManifest(h,`${u.assets}/${r.fontAsset.url}`);console.log(`\u26AA sharing ${this.getFilenameFromUrl(m)} within session`);const y=await(await fetch(m)).arrayBuffer();t.flatMap(v=>v.options.fonts??[]).forEach(v=>{this.getFilenameFromUrl(v.url)===o&&(v.sharedFont={url:m,data:y})})})}async waitForSessionInitialization(){for(;!this.initialized;)await new Promise(t=>setTimeout(t,g.SESSION_INITIALIZATION_POLLING_INTERVAL_MS))}async start(){await this.waitForSessionInitialization(),console.log("\u{1F7E2} started session");const t={target:this,type:d.SessionStart,...l.createTimestamps()};this.raiseEventOnListeners(t),this.currentActivity=this.options.activities.find(Boolean),this.currentActivity?(a.configureDomForActivity(this.currentActivity),await this.currentActivity.start()):(console.warn("no activities in session."),this.end())}end(){console.log("\u{1F534} ended session"),a.hideM2c2Elements(),this.stop();const t={target:this,type:d.SessionEnd,...l.createTimestamps()};this.raiseEventOnListeners(t)}stop(){this.dispose()}dispose(){}async goToActivity(t){const i=this.options.activities.filter(o=>o.id===t.id).find(Boolean);if(!i)throw new Error(`Error in goToActivity(): Session does not contain an activity with id ${t.id}.`);this.currentActivity&&this.currentActivity.stop();const e=i,s=e.constructor.bind.apply(e.constructor,[null]);this.currentActivity=new s;const n=this.options.activities.indexOf(e);this.options.activities[n]=this.currentActivity,a.configureDomForActivity(this.currentActivity),this.currentActivity.dataStores=this.dataStores,e.additionalParameters&&this.currentActivity.setParameters(e.additionalParameters),await this.currentActivity.initialize(),await this.currentActivity.start()}async goToNextActivity(){if(!this.currentActivity)throw new Error("error in advanceToNextActivity(): no current activity");if(!this.nextActivity)throw new Error("error in advanceToNextActivity(): no next activity");this.currentActivity.stop(),this.currentActivity=this.nextActivity,a.configureDomForActivity(this.currentActivity),await this.currentActivity.start()}async advanceToNextActivity(){await this.goToNextActivity()}get nextActivity(){if(!this.currentActivity)throw new Error("error in get nextActivity(): no current activity");if(this.options.activities.indexOf(this.currentActivity)===this.options.activities.length-1)return;const i=this.options.activities.indexOf(this.currentActivity);return this.options.activities[i+1]}dictionarySetItem(t,i){this.sessionDictionary.set(t,i)}dictionaryGetItem(t){return this.sessionDictionary.get(t)}dictionaryDeleteItem(t){return this.sessionDictionary.delete(t)}dictionaryItemExists(t){return this.sessionDictionary.has(t)}getFilenameFromUrl(t){return t.substring(t.lastIndexOf("/")+1)}getDuplicates(t){const i={},e=[];for(const s of t)i[s]=(i[s]||0)+1,i[s]===2&&e.push(s);return e}get uuid(){if(!this._uuid)throw new Error("Session.uuid is undefined.");return this._uuid}set uuid(t){this._uuid=t}}console.log("\u26AA @m2c2kit/session version 0.3.11 (d1ad307f)");export{a as DomHelper,S as Session,d as SessionEventType};
